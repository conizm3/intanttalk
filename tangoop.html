<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>TANGOOP</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #F8FAFC;
            --text-main: #475569;
            --accent: #258FAF;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Neumorphism Utilities */
        .neu-flat {
            background: var(--bg-color);
            box-shadow: 5px 5px 10px #E2E8F0, -5px -5px 10px #FFFFFF;
            border-radius: 16px;
        }
        .neu-pressed {
            background: var(--bg-color);
            box-shadow: inset 3px 3px 6px #E2E8F0, inset -3px -3px 6px #FFFFFF;
            border-radius: 12px;
        }
        .neu-btn {
            background: var(--bg-color);
            box-shadow: 4px 4px 8px #E2E8F0, -4px -4px 8px #FFFFFF;
            border-radius: 12px;
            transition: transform 0.1s;
        }
        .neu-btn:active {
            box-shadow: inset 2px 2px 4px #E2E8F0, inset -2px -2px 4px #FFFFFF;
            transform: scale(0.98);
        }
        .neu-input {
            background: var(--bg-color);
            box-shadow: inset 4px 4px 8px #E2E8F0, inset -4px -4px 8px #FFFFFF;
            border-radius: 16px;
            outline: none;
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card-flip { perspective: 1000px; }
        .card-inner { transition: transform 0.6s; transform-style: preserve-3d; position: relative; width: 100%; height: 100%; }
        .card-front, .card-back { backface-visibility: hidden; position: absolute; width: 100%; height: 100%; }
        .card-back { transform: rotateY(180deg); }
        .flipped .card-inner { transform: rotateY(180deg); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Utility Functions ---
        const extractJSON = (text) => {
            if(!text) return "{}";
            const start = text.indexOf('{');
            const end = text.lastIndexOf('}');
            if (start !== -1 && end !== -1 && end > start) {
                return text.substring(start, end + 1);
            }
            return null; // JSONが見つからない場合はnull
        };

        const speak = (text) => {
            if (!text) return;
            window.speechSynthesis.cancel();
            const ut = new SpeechSynthesisUtterance(text);
            ut.lang = 'en-US';
            window.speechSynthesis.speak(ut);
        };

        // --- Components ---

        // Toast Notification
        const Toast = ({ msg, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, []);
            return (
                <div className="fixed bottom-24 left-1/2 transform -translate-x-1/2 neu-flat px-6 py-3 rounded-full text-sm text-[#258FAF] font-bold z-50 fade-in shadow-lg text-center whitespace-nowrap">
                    {msg}
                </div>
            );
        };

        // API Key Modal
        const SettingsModal = ({ isOpen, onClose, currentKey, onSave }) => {
            const [inputVal, setInputVal] = useState(currentKey);
            
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-slate-100/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm fade-in">
                    <div className="neu-flat bg-[#F8FAFC] p-6 w-full max-w-md">
                        <h2 className="text-lg font-bold text-[#258FAF] mb-2">APIキー設定</h2>
                        <p className="text-xs text-gray-500 mb-4">Google AI StudioのAPIキーを入力してください。</p>
                        <input 
                            type="password" 
                            className="neu-input w-full p-4 mb-4 text-gray-600 font-mono" 
                            placeholder="AIzaSy..." 
                            value={inputVal}
                            onChange={(e) => setInputVal(e.target.value)}
                        />
                        <button 
                            onClick={() => onSave(inputVal)} 
                            className="w-full bg-[#258FAF] text-white font-bold p-4 rounded-xl shadow-lg active:scale-95 transition-transform"
                        >
                            保存して閉じる
                        </button>
                        <div className="text-center mt-4">
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs text-[#258FAF] underline">APIキーを取得 (無料)</a>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Views ---

        // 1. Search View
        const SearchView = ({ apiKey, onSaveWord, savedWords, setToast, externalResult, setExternalResult }) => {
            const [term, setTerm] = useState('');
            const [loading, setLoading] = useState(false);
            const resultRef = useRef(null);
            
            // Effect to load external result if provided
            useEffect(() => {
                // External result handling
            }, [externalResult]);

            const handleSearch = async (e) => {
                e.preventDefault();
                if (!term.trim()) return;
                if (!apiKey) return setToast('APIキーを設定してください');

                setLoading(true);
                setExternalResult(null);

                // プロンプトをシンプルにして成功率を上げる
                const prompt = `
                Explain the word "${term}".
                Output JSON with keys: word, definition(Japanese), example(English), tips(Japanese).
                Ensure valid JSON.
                `;

                const models = ['gemini-1.5-flash', 'gemini-pro'];
                let success = false;
                let finalData = null;

                for (const model of models) {
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                        });
                        
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error?.message || 'API Error');
                        
                        let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (!text) throw new Error('No text content');

                        // JSON抽出を試みる
                        let jsonStr = extractJSON(text);
                        
                        if (jsonStr) {
                            try {
                                finalData = JSON.parse(jsonStr);
                            } catch (e) {
                                // JSONパース失敗時も諦めない
                                console.warn("JSON Parse failed", e);
                            }
                        }

                        // もしJSONパースに失敗、または抽出できなかった場合
                        // テキストをそのまま定義として扱うフォールバック処理
                        if (!finalData) {
                            finalData = {
                                word: term,
                                definition: text.replace(/```json|```/g, '').trim(), // コードブロック記号などを除去して表示
                                pronunciation: "",
                                example: "",
                                synonyms: [],
                                tips: "自動解析に失敗したため、AIの応答をそのまま表示しています。"
                            };
                        }
                        
                        // 必須項目の補完（undefined防止）
                        if (!finalData.word) finalData.word = term;
                        if (!finalData.definition) finalData.definition = "定義を取得できませんでした";
                        if (!finalData.pronunciation) finalData.pronunciation = "";
                        if (!finalData.example) finalData.example = "";
                        if (!finalData.tips) finalData.tips = "";
                        if (!finalData.synonyms) finalData.synonyms = [];

                        setExternalResult(finalData);
                        success = true;
                        break;
                    } catch (err) {
                        console.warn(`Model ${model} failed:`, err);
                    }
                }

                setLoading(false);
                if (!success) setToast('検索に失敗しました。APIキーや通信を確認してください。');
            };

            useEffect(() => {
                if (externalResult && resultRef.current) {
                    resultRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, [externalResult]);

            const currentData = externalResult;
            const isSaved = currentData && savedWords.some(w => w.word === currentData.word);

            return (
                <div className="fade-in">
                    <div className="mb-8 mt-2">
                        <form onSubmit={handleSearch} className="relative">
                            <input 
                                type="text" 
                                value={term}
                                onChange={(e) => setTerm(e.target.value)}
                                className="neu-input w-full p-4 pl-12 text-lg text-[#258FAF] placeholder-gray-400" 
                                placeholder="単語を入力 (例: Serendipity)" 
                            />
                            <i className="fas fa-search absolute left-5 top-5 text-gray-400"></i>
                            <button type="submit" className="absolute right-2 top-2 bg-[#258FAF] text-white w-12 h-12 flex items-center justify-center rounded-xl shadow-md active:scale-95 transition-transform">
                                <i className="fas fa-arrow-right"></i>
                            </button>
                        </form>
                        <p className="text-[10px] text-gray-400 text-center mt-3 tracking-widest">ENGLISH ⇆ JAPANESE</p>
                    </div>

                    {loading && (
                        <div className="flex flex-col items-center justify-center py-12">
                            <div className="animate-spin rounded-full h-10 w-10 border-b-2 border-[#258FAF] mb-4"></div>
                            <p className="text-sm text-gray-500 animate-pulse">AIが解析中...</p>
                        </div>
                    )}

                    {!loading && !currentData && (
                        <div className="text-center py-20 opacity-40 select-none">
                            <div className="neu-flat w-32 h-32 rounded-full flex items-center justify-center mx-auto mb-6 text-[#258FAF]">
                                <i className="fas fa-search text-4xl"></i>
                            </div>
                            <p className="font-bold text-gray-500">単語を入力して検索</p>
                            <p className="text-xs text-gray-400 mt-2">AIがあなたの学習をサポートします</p>
                        </div>
                    )}

                    {currentData && (
                        <div ref={resultRef} className="neu-flat p-6 mb-8 fade-in">
                            <div className="flex justify-between items-start mb-6">
                                <div>
                                    <h2 className="text-3xl font-bold text-[#258FAF] break-all">{currentData.word}</h2>
                                    {currentData.pronunciation && (
                                        <p className="text-sm text-gray-500 font-mono mt-1">{currentData.pronunciation}</p>
                                    )}
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => speak(currentData.word)} className="neu-btn w-10 h-10 flex items-center justify-center rounded-full text-[#258FAF]">
                                        <i className="fas fa-volume-up"></i>
                                    </button>
                                    <button 
                                        onClick={() => onSaveWord(currentData)} 
                                        className={`neu-btn w-10 h-10 flex items-center justify-center rounded-full ${isSaved ? 'text-yellow-500 neu-pressed' : 'text-gray-400'}`}
                                    >
                                        <i className="fas fa-bookmark"></i>
                                    </button>
                                </div>
                            </div>

                            <div className="space-y-6">
                                <div className="bg-white/50 p-3 rounded-xl border border-white">
                                    <span className="text-xs font-bold text-[#258FAF] block mb-1 opacity-70">意味</span>
                                    <p className="text-lg font-bold text-gray-700 leading-relaxed whitespace-pre-wrap">{currentData.definition}</p>
                                </div>

                                {currentData.example && (
                                    <div className="neu-pressed p-4 relative overflow-hidden">
                                        <div className="absolute left-0 top-0 bottom-0 w-1 bg-[#258FAF] opacity-50"></div>
                                        <span className="text-[10px] font-bold text-gray-400 uppercase block mb-1 pl-2">Example</span>
                                        <p className="text-gray-600 italic pl-2 leading-relaxed">"{currentData.example}"</p>
                                    </div>
                                )}

                                {currentData.synonyms && currentData.synonyms.length > 0 && (
                                    <div>
                                        <span className="text-xs font-bold text-gray-400 block mb-2">類義語</span>
                                        <div className="flex flex-wrap gap-2">
                                            {currentData.synonyms.slice(0,3).map((syn, i) => (
                                                <span key={i} className="neu-pressed px-3 py-1 text-xs text-gray-500 rounded-lg">{syn}</span>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {currentData.tips && (
                                    <div className="pt-4 border-t border-gray-200/50 flex gap-2 items-start">
                                        <i className="fas fa-info-circle text-[#258FAF] mt-1 text-xs"></i>
                                        <div>
                                            <span className="text-xs font-bold text-[#258FAF]">MEMO</span>
                                            <p className="text-sm text-gray-500 mt-1 leading-relaxed">{currentData.tips}</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 2. List View
        const ListView = ({ savedWords, onDeleteWord, onSelectWord }) => {
            if (savedWords.length === 0) {
                return (
                    <div className="text-center py-20 text-gray-400 fade-in">
                        <div className="neu-pressed w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i className="fas fa-book-open text-3xl"></i>
                        </div>
                        <p>保存された単語はありません</p>
                    </div>
                );
            }

            return (
                <div className="fade-in">
                    <h2 className="text-xl font-bold mb-6 text-[#258FAF] ml-2">単語帳 <span className="text-sm font-normal text-gray-500 ml-2">({savedWords.length})</span></h2>
                    <div className="space-y-4">
                        {savedWords.map((item, idx) => (
                            <div key={idx} onClick={() => onSelectWord(item)} className="neu-flat p-4 flex justify-between items-center cursor-pointer active:scale-[0.99] transition">
                                <div className="overflow-hidden">
                                    <div className="font-bold text-[#258FAF]">{item.word}</div>
                                    <div className="text-xs text-gray-500 truncate w-48">{item.definition}</div>
                                </div>
                                <button 
                                    className="neu-btn w-8 h-8 flex items-center justify-center rounded-full text-gray-400 hover:text-red-400 ml-2 shrink-0" 
                                    onClick={(e) => { e.stopPropagation(); onDeleteWord(item.word); }}
                                >
                                    <i className="fas fa-trash"></i>
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // 3. Review View
        const ReviewView = ({ savedWords, onFinish }) => {
            const [isStarted, setIsStarted] = useState(false);
            const [queue, setQueue] = useState([]);
            const [index, setIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);

            const startReview = () => {
                if (savedWords.length === 0) return alert('単語帳が空です');
                const shuffled = [...savedWords].sort(() => Math.random() - 0.5);
                setQueue(shuffled);
                setIndex(0);
                setIsFlipped(false);
                setIsStarted(true);
            };

            const nextCard = () => {
                if (index >= queue.length - 1) {
                    alert('復習完了！お疲れ様でした。');
                    onFinish(); // Go back to home or reset
                } else {
                    setIsFlipped(false);
                    setIndex(prev => prev + 1);
                }
            };

            if (!isStarted) {
                return (
                    <div className="h-full flex flex-col justify-center items-center text-center fade-in">
                        <div className="neu-flat w-40 h-40 rounded-full flex items-center justify-center mb-8 text-[#258FAF]">
                            <i className="fas fa-graduation-cap text-6xl"></i>
                        </div>
                        <h2 className="text-2xl font-bold mb-2 text-[#258FAF]">Review Mode</h2>
                        <p className="text-gray-500 mb-10 text-sm">保存した単語からランダムに出題</p>
                        <button onClick={startReview} className="bg-[#258FAF] text-white px-10 py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition-transform">
                            テストを開始
                        </button>
                    </div>
                );
            }

            const currentCard = queue[index];
            const maskedExample = currentCard.example ? currentCard.example.replace(new RegExp(currentCard.word, 'gi'), '_______') : "...";

            return (
                <div className="h-full flex flex-col items-center justify-center pb-4 relative fade-in">
                    <div className={`w-full max-w-sm h-[420px] card-flip cursor-pointer ${isFlipped ? 'flipped' : ''}`} onClick={() => {
                        if(!isFlipped) speak(currentCard.word);
                        setIsFlipped(true);
                    }}>
                        <div className="card-inner">
                            {/* Front */}
                            <div className="card-front neu-flat flex flex-col items-center justify-center p-8 text-center bg-[#F8FAFC]">
                                <span className="absolute top-6 left-6 text-xs font-bold text-gray-400">QUESTION</span>
                                <h2 className="text-4xl font-bold text-[#258FAF] mb-8 break-all">{currentCard.word}</h2>
                                <div className="neu-pressed w-full p-4 rounded-xl">
                                    <p className="text-[10px] text-gray-400 mb-1">HINT</p>
                                    <p className="text-sm text-gray-600 italic">"{maskedExample}"</p>
                                </div>
                                <p className="absolute bottom-6 text-xs text-gray-400 opacity-60">タップして答えを表示</p>
                            </div>
                            {/* Back */}
                            <div className="card-back neu-flat flex flex-col items-center justify-center p-8 text-center bg-gradient-to-b from-[#F8FAFC] to-white">
                                <span className="absolute top-6 left-6 text-xs font-bold text-[#258FAF]">ANSWER</span>
                                <h3 className="text-xl font-bold text-gray-700 mb-4 break-all">{currentCard.definition}</h3>
                                <div className="w-8 h-1 bg-[#258FAF] opacity-20 rounded-full mb-4"></div>
                                <p className="text-xs text-gray-500">{currentCard.tips}</p>
                                <button 
                                    onClick={(e) => { e.stopPropagation(); speak(currentCard.word); }} 
                                    className="neu-btn w-12 h-12 flex items-center justify-center rounded-full mt-6 text-[#258FAF]"
                                >
                                    <i className="fas fa-volume-up"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div className={`w-full max-w-sm flex gap-4 mt-8 transition-opacity ${isFlipped ? 'opacity-100 pointer-events-auto' : 'opacity-50 pointer-events-none'}`}>
                        <button onClick={nextCard} className="flex-1 neu-btn py-4 font-bold text-gray-500 hover:text-red-400">忘れた</button>
                        <button onClick={nextCard} className="flex-1 neu-btn py-4 font-bold text-gray-500 hover:text-[#258FAF]">覚えた</button>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---
        const App = () => {
            const [tab, setTab] = useState('search');
            const [apiKey, setApiKey] = useState(localStorage.getItem('aitan_api_key') || '');
            const [savedWords, setSavedWords] = useState(JSON.parse(localStorage.getItem('aitan_words')) || []);
            const [isSettingsOpen, setIsSettingsOpen] = useState(!apiKey);
            const [toastMsg, setToastMsg] = useState(null);
            const [searchResult, setSearchResult] = useState(null);

            // Persist logic
            useEffect(() => {
                localStorage.setItem('aitan_api_key', apiKey);
            }, [apiKey]);

            useEffect(() => {
                localStorage.setItem('aitan_words', JSON.stringify(savedWords));
            }, [savedWords]);

            const showToast = (msg) => {
                setToastMsg(msg);
            };

            const handleSaveWord = (wordData) => {
                const exists = savedWords.some(w => w.word === wordData.word);
                if (exists) {
                    setSavedWords(prev => prev.filter(w => w.word !== wordData.word));
                    showToast('削除しました');
                } else {
                    setSavedWords(prev => [wordData, ...prev]);
                    showToast('保存しました');
                }
            };

            const handleDeleteWord = (word) => {
                if(confirm('削除しますか？')) {
                    setSavedWords(prev => prev.filter(w => w.word !== word));
                }
            };

            const handleListClick = (wordData) => {
                setSearchResult(wordData);
                setTab('search');
            };

            return (
                <div className="h-screen flex flex-col overflow-hidden">
                    <header className="p-4 z-20 flex justify-between items-center h-16 neu-flat mx-4 mt-4 mb-2">
                        <h1 className="text-xl font-bold tracking-tight text-[#258FAF]">TANGOOP</h1>
                        <button onClick={() => setIsSettingsOpen(true)} className="neu-btn px-4 py-2 text-xs font-bold flex items-center gap-2">
                            <i className="fas fa-cog"></i> Key設定
                        </button>
                    </header>

                    <main className="flex-1 overflow-y-auto p-4 pb-24 no-scrollbar relative">
                        <SettingsModal 
                            isOpen={isSettingsOpen} 
                            onClose={() => setIsSettingsOpen(false)} 
                            currentKey={apiKey}
                            onSave={(key) => { setApiKey(key); setIsSettingsOpen(false); showToast('設定を保存しました'); }}
                        />

                        {tab === 'search' && (
                            <SearchView 
                                apiKey={apiKey} 
                                savedWords={savedWords} 
                                onSaveWord={handleSaveWord} 
                                setToast={showToast}
                                externalResult={searchResult}
                                setExternalResult={setSearchResult}
                            />
                        )}
                        {tab === 'list' && (
                            <ListView 
                                savedWords={savedWords} 
                                onDeleteWord={handleDeleteWord} 
                                onSelectWord={handleListClick}
                            />
                        )}
                        {tab === 'review' && (
                            <ReviewView 
                                savedWords={savedWords} 
                                onFinish={() => setTab('search')}
                            />
                        )}
                    </main>

                    <nav className="neu-flat mx-4 mb-4 h-20 flex justify-around items-center z-20">
                        <button onClick={() => setTab('search')} className={`nav-btn flex flex-col items-center w-1/3 ${tab === 'search' ? 'tab-active' : 'tab-inactive'}`}>
                            <div className={`w-10 h-10 flex items-center justify-center rounded-xl mb-1 transition-all ${tab === 'search' ? 'neu-pressed' : ''}`}>
                                <i className="fas fa-search text-lg"></i>
                            </div>
                            <span className="text-[10px] font-bold">検索</span>
                        </button>
                        <button onClick={() => setTab('review')} className={`nav-btn flex flex-col items-center w-1/3 ${tab === 'review' ? 'tab-active' : 'tab-inactive'}`}>
                            <div className={`w-10 h-10 flex items-center justify-center rounded-xl mb-1 transition-all ${tab === 'review' ? 'neu-pressed' : ''}`}>
                                <i className="fas fa-brain text-lg"></i>
                            </div>
                            <span className="text-[10px] font-bold">復習</span>
                        </button>
                        <button onClick={() => setTab('list')} className={`nav-btn flex flex-col items-center w-1/3 ${tab === 'list' ? 'tab-active' : 'tab-inactive'}`}>
                            <div className={`w-10 h-10 flex items-center justify-center rounded-xl mb-1 transition-all ${tab === 'list' ? 'neu-pressed' : ''}`}>
                                <i className="fas fa-book text-lg"></i>
                            </div>
                            <span className="text-[10px] font-bold">単語帳</span>
                        </button>
                    </nav>

                    {toastMsg && <Toast msg={toastMsg} onClose={() => setToastMsg(null)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
