import React, { useState, useEffect, useRef } from 'react';
import { 
  Mic, MicOff, Send, Play, RotateCcw, MessageSquare, CheckCircle, Volume2, X, Edit3, Lightbulb, 
  ArrowRight, BookOpen, GraduationCap, Home, LogOut, Loader, Coffee, Hotel, Plane, Briefcase, Sparkles
} from 'lucide-react';

// --- API å®šæ•°è¨­å®š ---
// ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®TTSã«æˆ»ã™ãŸã‚ã€TTS APIã®å®šæ•°ã¯ä¸è¦
const AI_MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
const AI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${AI_MODEL_NAME}:generateContent?key=`;
const MAX_RETRIES = 3;

// --- æ¨™æº–TTS Helper Function (ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®èª­ã¿ä¸Šã’æ©Ÿèƒ½) ---
const speak = (text) => {
    if ('speechSynthesis' in window) {
        // ç¾åœ¨èª­ã¿ä¸Šã’ä¸­ã®éŸ³å£°ãŒã‚ã‚Œã°åœæ­¢
        window.speechSynthesis.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        // è‹±èªã®ç™ºéŸ³ã‚’æŒ‡å®š
        utterance.lang = 'en-US';
        // æ¨™æº–æ©Ÿèƒ½ã§ã¯éŸ³å£°å“è³ªã®é¸æŠã¯ã§ãã¾ã›ã‚“ãŒã€å¯èƒ½ãªé™ã‚Šè‡ªç„¶ã«èã“ãˆã‚‹ã‚ˆã†è¨­å®š
        utterance.rate = 1.0; 
        utterance.pitch = 1.0; 

        window.speechSynthesis.speak(utterance);
        return new Promise(resolve => {
            utterance.onend = resolve;
            utterance.onerror = resolve; // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚promiseã‚’è§£æ±ºã—ã¦æ¬¡ã¸é€²ã‚€
        });
    } else {
        console.error("Speech Synthesis is not supported in this browser.");
        return Promise.resolve();
    }
};

// --- å›ºå®šã‚·ãƒŠãƒªã‚ªç”¨ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸå°æœ¬ ---
const HARDCODED_SCRIPTS = {
  restaurant: [
    { role: 'ai', en: 'Good evening, welcome to The Grand Bistro. Do you have a reservation with us tonight?', ja: 'ã“ã‚“ã°ã‚“ã¯ã€ã‚¶ãƒ»ã‚°ãƒ©ãƒ³ãƒ‰ãƒ»ãƒ“ã‚¹ãƒˆãƒ­ã¸ã‚ˆã†ã“ãã€‚ä»Šå¤œã¯ã”äºˆç´„ã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ' },
    { role: 'user', en: 'Yes, I have a reservation under the name Smith.', ja: 'ã¯ã„ã€ã‚¹ãƒŸã‚¹ã¨ã„ã†åå‰ã§äºˆç´„ã—ã¦ã„ã¾ã™ã€‚' },
    { role: 'ai', en: 'Ah, yes, Mr. Smith. A table for two right this way. May I get you started with some drinks?', ja: 'ãˆãˆã€ã‚¹ãƒŸã‚¹æ§˜ã§ã™ã­ã€‚ã“ã¡ã‚‰ã¸ã©ã†ãã€2åæ§˜ã®ãŠå¸­ã§ã™ã€‚ã¾ãšãŠé£²ã¿ç‰©ã‹ã‚‰ã„ã‹ãŒã§ã™ã‹ï¼Ÿ' },
    { role: 'user', en: 'I\'ll take a glass of the house white wine, please.', ja: 'ãƒã‚¦ã‚¹ãƒ¯ã‚¤ãƒ³ã®ç™½ã‚’ã‚°ãƒ©ã‚¹ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚' },
    { role: 'ai', en: 'Excellent choice. And for you, madam?', ja: 'ã‹ã—ã“ã¾ã‚Šã¾ã—ãŸã€‚å¥¥æ§˜ã¯ã„ã‹ãŒã§ã™ã‹ï¼Ÿ' },
  ],
  hotel: [
    { role: 'ai', en: 'Good afternoon, welcome to the Stellar Hotel. How may I assist you with your check-in?', ja: 'ã“ã‚“ã«ã¡ã¯ã€ã‚¹ãƒ†ãƒ©ãƒ›ãƒ†ãƒ«ã¸ã‚ˆã†ã“ãã€‚ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã®ãŠæ‰‹ä¼ã„ã‚’ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚' },
    { role: 'user', en: 'I have a reservation under the name Tanaka.', ja: 'ã‚¿ãƒŠã‚«ã¨ã„ã†åå‰ã§äºˆç´„ã—ã¦ã„ã¾ã™ã€‚' },
    { role: 'ai', en: 'Thank you, Mr. Tanaka. Could I please see your passport and reservation confirmation?', ja: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€ç”°ä¸­æ§˜ã€‚ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã¨äºˆç´„ç¢ºèªæ›¸ã‚’æ‹è¦‹ã§ãã¾ã™ã‹ï¼Ÿ' },
    { role: 'user', en: 'Certainly, here they are.', ja: 'ã‚‚ã¡ã‚ã‚“ã§ã™ã€ã©ã†ãã€‚' },
    { role: 'ai', en: 'Thank you. Your room is 1405, on the 14th floor. Here is your key card. Enjoy your stay.', ja: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ãŠéƒ¨å±‹ã¯14éšã®1405å·å®¤ã§ã™ã€‚ã“ã¡ã‚‰ãŒã‚­ãƒ¼ã‚«ãƒ¼ãƒ‰ã§ã™ã€‚ã”æ»åœ¨ã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚' },
  ],
  airport: [
    { role: 'ai', en: 'Good morning. Where are you flying to today?', ja: 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™ã€‚æœ¬æ—¥ã¯ã©ã¡ã‚‰ã¸è¡Œã‹ã‚Œã¾ã™ã‹ï¼Ÿ' },
    { role: 'user', en: 'I\'m flying to London. Here is my passport and ticket.', ja: 'ãƒ­ãƒ³ãƒ‰ãƒ³ã¸è¡Œãã¾ã™ã€‚ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã¨ãƒã‚±ãƒƒãƒˆã§ã™ã€‚' },
    { role: 'ai', en: 'Thank you. Do you have any check-in baggage?', ja: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ãŠé ã‘ã«ãªã‚‹æ‰‹è·ç‰©ã¯ã”ã–ã„ã¾ã™ã‹ï¼Ÿ' },
    { role: 'user', en: 'Yes, just this one suitcase.', ja: 'ã¯ã„ã€ã“ã®ã‚¹ãƒ¼ãƒ„ã‚±ãƒ¼ã‚¹ä¸€ã¤ã ã‘ã§ã™ã€‚' },
    { role: 'ai', en: 'Please place it on the scale. Your flight is departing from Gate 35. Boarding will begin at 8:30 AM.', ja: 'ç§¤ã®ä¸Šã«ç½®ã„ã¦ãã ã•ã„ã€‚ã”æ­ä¹—ã®ä¾¿ã¯35ç•ªã‚²ãƒ¼ãƒˆã‹ã‚‰å‡ºç™ºã—ã¾ã™ã€‚æ­ä¹—é–‹å§‹ã¯åˆå‰8æ™‚30åˆ†ã§ã™ã€‚' },
  ],
  interview: [
    { role: 'ai', en: 'Thank you for coming in, Mr. Sato. Could you please start by telling us a little bit about yourself?', ja: 'ä½è—¤ã•ã‚“ã€ãŠè¶Šã—ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã¾ãšã€ã”è‡ªèº«ã«ã¤ã„ã¦å°‘ã—ãŠè©±ã—ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ' },
    { role: 'user', en: 'Certainly. I have been working as a software engineer for five years, specializing in web development.', ja: 'ã‚‚ã¡ã‚ã‚“ã§ã™ã€‚ç§ã¯ã‚¦ã‚§ãƒ–é–‹ç™ºã‚’å°‚é–€ã¨ã™ã‚‹ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦5å¹´é–“åƒã„ã¦ã„ã¾ã™ã€‚' },
    { role: 'ai', en: 'That is interesting. What primarily motivated you to apply for this position at our company?', ja: 'ãã‚Œã¯èˆˆå‘³æ·±ã„ã§ã™ã­ã€‚ä¸»ã«å½“ç¤¾ã®ã“ã®ãƒã‚¸ã‚·ãƒ§ãƒ³ã«å¿œå‹Ÿã—ã‚ˆã†ã¨æ€ã£ãŸãã£ã‹ã‘ã¯ä½•ã§ã™ã‹ï¼Ÿ' },
    { role: 'user', en: 'I am highly impressed by your commitment to innovative green technology.', ja: 'è²´ç¤¾ã®é©æ–°çš„ãªã‚°ãƒªãƒ¼ãƒ³ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ã¸ã®å–ã‚Šçµ„ã¿ã«éå¸¸ã«æ„ŸéŠ˜ã‚’å—ã‘ã¾ã—ãŸã€‚' },
    { role: 'ai', en: 'We appreciate that. Can you describe a challenging project you have managed and how you overcame it?', ja: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã‚ãªãŸãŒç®¡ç†ã—ãŸä¸­ã§ã€å›°é›£ã ã£ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã€ãã‚Œã‚’ã©ã®ã‚ˆã†ã«ä¹—ã‚Šè¶ŠãˆãŸã‹èª¬æ˜ã—ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ' },
  ],
};

// --- ãƒ‡ãƒ¼ã‚¿å®šç¾© ---
const SCENARIOS = [
  { id: 'restaurant', icon: Coffee, title: 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³', prompt: 'ã‚ãªãŸã¯é«˜ç´šãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã®ã‚¦ã‚§ã‚¤ã‚¿ãƒ¼ã§ã™ã€‚ãŠã™ã™ã‚ã‚’ç´¹ä»‹ã—ã€æ³¨æ–‡ã‚’ã¨ã£ã¦ãã ã•ã„ã€‚ã“ã®ä¼šè©±ã®ç›®çš„ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ–™ç†ã¨é£²ã¿ç‰©ã‚’æ³¨æ–‡ã™ã‚‹ã“ã¨ã§ã™ã€‚' },
  { id: 'hotel', icon: Hotel, title: 'ãƒ›ãƒ†ãƒ«ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³', prompt: 'ã‚ãªãŸã¯ãƒ›ãƒ†ãƒ«ã®ãƒ•ãƒ­ãƒ³ãƒˆä¿‚ã§ã™ã€‚äºˆç´„ç¢ºèªã¨ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ‰‹ç¶šãã‚’è¡Œã£ã¦ãã ã•ã„ã€‚ã“ã®ä¼šè©±ã®ç›®çš„ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚’å®Œäº†ã—ã€éƒ¨å±‹ã®æƒ…å ±ã‚’å¾—ã‚‹ã“ã¨ã§ã™ã€‚' },
  { id: 'airport', icon: Plane, title: 'ç©ºæ¸¯ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼', prompt: 'ã‚ãªãŸã¯å›½éš›ç·šã®èˆªç©ºä¼šç¤¾ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è·å“¡ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ­ä¹—æ‰‹ç¶šãã¨è·ç‰©é ã‹ã‚Šã‚’è¡Œã£ã¦ãã ã•ã„ã€‚ã“ã®ä¼šè©±ã®ç›®çš„ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ­ä¹—æ‰‹ç¶šãã‚’å®Œäº†ã™ã‚‹ã“ã¨ã§ã™ã€‚' },
  { id: 'interview', icon: Briefcase, title: 'è‹±èªé¢æ¥', prompt: 'ã‚ãªãŸã¯ITä¼æ¥­ã®é¢æ¥å®˜ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®çµŒé¨“ã¨ã‚¹ã‚­ãƒ«ã«ã¤ã„ã¦è³ªå•ã—ã¦ãã ã•ã„ã€‚ã“ã®ä¼šè©±ã®ç›®çš„ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªå·±ç´¹ä»‹ã¨è·å‹™çµŒé¨“ã‚’è‹±èªã§èª¬æ˜ã™ã‚‹ã“ã¨ã§ã™ã€‚' },
  { id: 'custom', icon: Sparkles, title: 'è‡ªç”±è¨­å®š', prompt: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¨­å®šã—ãŸçŠ¶æ³ã§ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ã‚’è¡Œã„ã¾ã™ã€‚' },
];

// --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° (æŒ‡æ•°é–¢æ•°çš„ãƒãƒƒã‚¯ã‚ªãƒ•ä»˜ããƒ•ã‚§ãƒƒãƒ) ---
async function fetchWithRetry(url, payload) {
  let attempt = 0;
  while (attempt < MAX_RETRIES) {
    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      return await response.json();

    } catch (error) {
      console.error(`Attempt ${attempt + 1} failed for ${url}:`, error.message);
      if (attempt < MAX_RETRIES - 1) {
        const delay = Math.pow(2, attempt) * 1000; // 1s, 2s, 4s...
        await new Promise(resolve => setTimeout(resolve, delay));
        attempt++;
      } else {
        throw new Error(`Failed to connect to API (${url}) after multiple retries.`);
      }
    }
  }
  throw new Error(`Maximum retries reached for API call (${url}).`);
}

// --- AIé€£æºãƒ­ã‚¸ãƒƒã‚¯ (ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒŠãƒªã‚ªã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å°‚ç”¨) ---

/**
 * ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒŠãƒªã‚ªã«åŸºã¥ã„ãŸä¼šè©±ã®å°å…¥å°æœ¬ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
 */
async function generateScript(systemPrompt) {
  const userQuery = "ã“ã®ã‚·ãƒŠãƒªã‚ªã®å°å…¥ã¨ã—ã¦ã€AI (ç›¸æ‰‹å½¹) ã®æœ€åˆã®ç™ºè¨€ã‹ã‚‰ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ¬¡ã®å¿œç­”ã‚’ã™ã‚‹ã¾ã§ã®4å¾€å¾©ã®ä¼šè©±ã‚’ã€è‹±èªã¨æ—¥æœ¬èªã§ä½œæˆã—ã¦ãã ã•ã„ã€‚è‹±èªã¯è‡ªç„¶ã§ä¸å¯§ãªè¡¨ç¾ã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚";

  const payload = {
    contents: [{ parts: [{ text: userQuery }] }],
    systemInstruction: {
        parts: [{ text: systemPrompt + " å›ç­”ã¯ä»¥ä¸‹ã®JSONã‚¹ã‚­ãƒ¼ãƒã«å¾“ã£ã¦ãã ã•ã„ã€‚" }]
    },
    generationConfig: {
      responseMimeType: "application/json",
      responseSchema: {
        type: "ARRAY",
        items: {
          type: "OBJECT",
          properties: {
            "role": { "type": "STRING", enum: ["ai", "user"] },
            "en": { "type": "STRING", description: "è‡ªç„¶ãªè‹±èªã§ã®ã‚»ãƒªãƒ•" },
            "ja": { "type": "STRING", description: "ã‚»ãƒªãƒ•ã®æ—¥æœ¬èªè¨³" },
          },
          required: ["role", "en", "ja"]
        }
      }
    }
  };

  const result = await fetchWithRetry(AI_API_URL, payload);
  const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
  
  if (jsonText) {
    try {
        return JSON.parse(jsonText);
    } catch (e) {
        console.error("JSON parse error from API:", e);
        throw new Error("AI returned malformed script data.");
    }
  }
  
  throw new Error("AI did not return any content for the script.");
}

/**
 * ä¼šè©±ã®æµã‚Œã«åŸºã¥ãã€AIã®æ¬¡ã®ç™ºè¨€ã‚’è‹±èªã§ç”Ÿæˆã—ã¾ã™ã€‚
 */
async function generateAIResponse(systemPrompt, history) {
  const chatHistory = history.map(msg => ({
    role: msg.role === 'ai' ? 'model' : 'user',
    parts: [{ text: msg.text }]
  }));
  
  const payload = {
    contents: chatHistory,
    systemInstruction: {
        parts: [{ text: systemPrompt + " ã‚ãªãŸã¯ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ã®ç›¸æ‰‹å½¹ã§ã™ã€‚ç›´å‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€ã«å¯¾ã—ã¦ã€æ¬¡ã®è‡ªç„¶ãªè‹±èªã®ã‚»ãƒªãƒ•ã‚’ä¸€è¡Œã§è¿”ã—ã¦ãã ã•ã„ã€‚æ—¥æœ¬èªã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚ä¼šè©±ã‚’ä¸è‡ªç„¶ã«çµ‚äº†ã•ã›ãªã„ã§ãã ã•ã„ã€‚" }]
    },
  };

  const result = await fetchWithRetry(AI_API_URL, payload);
  const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
  
  return text?.trim() || "I'm sorry, I seem to be having a little trouble responding right now. Please try saying that again.";
}

/**
 * ä¼šè©±å…¨ä½“ã‚’åˆ†æã—ã€ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
 */
async function generateFeedback(systemPrompt, history) {
    const conversationText = history.map(msg => `${msg.role === 'user' ? 'User' : 'AI'}: ${msg.text}`).join('\n');
    const userQuery = `ä»¥ä¸‹ã®ä¼šè©±è¨˜éŒ²ã‚’åˆ†æã—ã€Userï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰ã®è‹±èªåŠ›ã«å¯¾ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
    
    ä¼šè©±è¨­å®š: ${systemPrompt}
    
    ä¼šè©±è¨˜éŒ²:
    ${conversationText}
    
    åˆ†æã«åŸºã¥ãã€ä»¥ä¸‹ã®JSONã‚¹ã‚­ãƒ¼ãƒã«å¾“ã£ã¦å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;

    const payload = {
        contents: [{ parts: [{ text: userQuery }] }],
        systemInstruction: {
            parts: [{ text: "ã‚ãªãŸã¯ãƒ—ãƒ­ã®è‹±èªã‚³ãƒ¼ãƒã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¼šè©±ã‚’è©³ç´°ã«åˆ†æã—ã€æ¡ç‚¹ï¼ˆ80ã€œ100ç‚¹ï¼‰ã¨å…·ä½“çš„ãªæ”¹å–„ç‚¹ã‚’æç¤ºã—ã¦ãã ã•ã„ã€‚å›ç­”ã¯å¿…ãšJSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚" }]
        },
        generationConfig: {
            responseMimeType: "application/json",
            responseSchema: {
                type: "OBJECT",
                properties: {
                    "score": { "type": "INTEGER", description: "ä¼šè©±ã®æµæš¢ã•ã€æ­£ç¢ºã•ã€é©åˆ‡ã•ã«åŸºã¥ã80ã‹ã‚‰100ã®æ•´æ•°ã‚¹ã‚³ã‚¢ã€‚" },
                    "summary": { "type": "STRING", description: "ä¼šè©±å…¨ä½“ã«é–¢ã™ã‚‹ç°¡æ½”ãªç·è©•ï¼ˆæ—¥æœ¬èªï¼‰ã€‚" },
                    "grammarPoints": {
                        "type": "ARRAY",
                        "items": {
                            "type": "OBJECT",
                            "properties": {
                                "original": { "type": "STRING", description: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…ƒã®ç™ºè¨€ã‹ã‚‰æŠœãå‡ºã—ãŸæ”¹å–„ã™ã¹ãéƒ¨åˆ†ã€‚" },
                                "corrected": { "type": "STRING", description: "ã‚ˆã‚Šè‡ªç„¶ã¾ãŸã¯æ­£ç¢ºãªä¿®æ­£æ¡ˆï¼ˆè‹±èªï¼‰ã€‚" },
                                "explanation": { "type": "STRING", description: "ãªãœä¿®æ­£ãŒå¿…è¦ã‹ã€ã©ã†æ”¹å–„ã™ã¹ãã‹ã®èª¬æ˜ï¼ˆæ—¥æœ¬èªï¼‰ã€‚" }
                            }
                        }
                    },
                    "suggestedPhrases": { "type": "ARRAY", "items": { "type": "STRING" }, description: "ã“ã®ã‚·ãƒŠãƒªã‚ªã§ä½¿ãˆã‚‹æ¨å¥¨ãƒ•ãƒ¬ãƒ¼ã‚ºï¼ˆè‹±èªï¼‰ã€‚æœ€å¤§3ã¤ã€‚" }
                },
                required: ["score", "summary", "grammarPoints", "suggestedPhrases"]
            }
        }
    };

    const result = await fetchWithRetry(AI_API_URL, payload);
    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
    
    if (jsonText) {
        try {
            return JSON.parse(jsonText);
        } catch (e) {
            console.error("JSON parse error from API:", e);
            throw new Error("AI returned malformed feedback data.");
        }
    }
    
    throw new Error("AI did not return any content for the feedback.");
}


// --- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---

export default function App() {
  const [screen, setScreen] = useState('home'); 
  const [scenario, setScenario] = useState(null);
  const [customSettings, setCustomSettings] = useState({ where: '', who: '', what: '' });
  const [messages, setMessages] = useState([]);
  const [scriptData, setScriptData] = useState([]);
  const [inputText, setInputText] = useState('');
  const [isRecording, setIsRecording] = useState(false);
  const [isSpeaking, setIsSpeaking] = useState(false); // TTSã®èª­ã¿ä¸Šã’çŠ¶æ…‹
  const [micStatus, setMicStatus] = useState('ãƒã‚¤ã‚¯ã‚’æŠ¼ã—ã¦è©±ã™'); 
  const [showSubtitles, setShowSubtitles] = useState(true);
  const [showScriptModal, setShowScriptModal] = useState(false);
  const [feedback, setFeedback] = useState(null);
  const [isLoading, setIsLoading] = useState(false); // AIå‡¦ç†ä¸­ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹

  const messagesEndRef = useRef(null);
  const recognition = useRef(null);
  const isSpeakingRef = useRef(isSpeaking); // èª­ã¿ä¸Šã’çŠ¶æ…‹ã‚’æœ€æ–°ã«ä¿ã¤ãŸã‚ã®Ref

  // isSpeakingã®çŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«Refã‚’æ›´æ–°
  useEffect(() => {
    isSpeakingRef.current = isSpeaking;
  }, [isSpeaking]);

  // --- çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆï¼†ãƒ›ãƒ¼ãƒ ã¸é·ç§» ---
  const goToHome = () => {
    // é€²è¡Œä¸­ã®éŸ³å£°ãŒã‚ã‚Œã°åœæ­¢
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
    }
    // é€²è¡Œä¸­ã®éŸ³å£°èªè­˜ãŒã‚ã‚Œã°åœæ­¢
    if (recognition.current) {
        recognition.current.abort();
    }

    setIsLoading(false);
    setIsSpeaking(false);
    setScenario(null);
    setScriptData([]);
    setMessages([]);
    setCustomSettings({ where: '', who: '', what: '' }); 
    setMicStatus('ãƒã‚¤ã‚¯ã‚’æŠ¼ã—ã¦è©±ã™'); 
    setScreen('home');
  };

  // --- èª­ã¿ä¸Šã’æ©Ÿèƒ½ (ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–) ---
  const handleSpeak = async (text) => {
    // èª­ã¿ä¸Šã’é–‹å§‹
    setIsSpeaking(true);
    await speak(text);
    // èª­ã¿ä¸Šã’çµ‚äº†
    setIsSpeaking(false);
  };


  // --- éŸ³å£°èªè­˜ã®è¨­å®š ---
  useEffect(() => {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      recognition.current = new SpeechRecognition();
      recognition.current.continuous = false;
      recognition.current.lang = 'en-US'; 
      recognition.current.interimResults = false;
      
      let finalTranscript = '';

      recognition.current.onstart = () => {
          // startãŒç™ºç«ã—ãŸã‚‰ã€Œèãå–ã‚Šä¸­ã€ã«æ›´æ–°
          setMicStatus('ğŸ”´ èãå–ã‚Šä¸­... è©±ã—çµ‚ã‚ã£ãŸã‚‰ãƒã‚¤ã‚¯ã‚’ã‚‚ã†ä¸€åº¦æŠ¼ã™ã‹ã€å°‘ã—å¾…ã£ã¦ãã ã•ã„ã€‚');
          setIsRecording(true);
          finalTranscript = ''; // ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
      };
      
      recognition.current.onresult = (event) => {
        finalTranscript = Array.from(event.results)
          .filter(r => r.isFinal)
          .map(r => r[0].transcript)
          .join('');
        
        if (finalTranscript) {
          setInputText(finalTranscript);
        }
      };
      
      recognition.current.onend = () => {
          // onendãŒå‘¼ã°ã‚ŒãŸæ™‚ç‚¹ã§isRecordingã‚’falseã«ã™ã‚‹
          setIsRecording(false);
          
          if (finalTranscript) {
              setMicStatus('âœ… éŸ³å£°å…¥åŠ›å®Œäº†ã€‚å†…å®¹ã‚’ç¢ºèªã—ã¦é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
          } else {
              setMicStatus('ğŸ”‡ éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒã‚¤ã‚¯ã‚’æŠ¼ã—ã¦ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
          }
      };
      
      recognition.current.onerror = (event) => {
        console.error("Speech Recognition Error:", event.error);
        setIsRecording(false);
        finalTranscript = ''; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒˆãƒ©ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç ´æ£„
        
        if (event.error === 'not-allowed') {
          setMicStatus('âŒ ãƒã‚¤ã‚¯ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã‚’ç¢ºèªã—ã€è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
        } else if (event.error === 'no-speech' || event.error === 'aborted') {
          // 'no-speech' ã¾ãŸã¯ 'aborted' ã®å ´åˆã€onendã§å‡¦ç†ã•ã‚Œã‚‹ã®ã§ã€ã“ã“ã§ã¯ç‰¹ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã—ãªã„
          // ã‚‚ã—onendã‚ˆã‚Šå…ˆã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ã€ã“ã“ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨­å®š
          setMicStatus('ğŸ”‡ éŸ³å£°ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†å°‘ã—å¤§ããã€ã¯ã£ãã‚Šè©±ã—ã¦ã¿ã¦ãã ã•ã„ã€‚');
        } else if (event.error === 'network') {
          setMicStatus('ğŸ“¶ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        } else {
          setMicStatus(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (${event.error})ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã¾ãŸã¯ç’°å¢ƒè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
        }
      };
    } else {
        setMicStatus('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        console.error("Speech Recognition is not supported in this browser.");
    }
    
    return () => {
      if (recognition.current) {
        recognition.current.abort();
      }
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
      }
    };
  }, []);

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ›´æ–°ã•ã‚ŒãŸã‚‰æœ€ä¸‹éƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  // --- ãƒ•ãƒ­ãƒ¼åˆ¶å¾¡ ---

  const handleScenarioSelect = async (selected) => {
    if (isLoading || isSpeakingRef.current) return; 

    setScenario(selected);
    setScriptData([]);
    
    if (selected.id === 'custom') {
      setScreen('custom_setup');
      return; 
    } 
    
    const script = HARDCODED_SCRIPTS[selected.id];
    if (script) {
        setScriptData(script);
        setScreen('script'); 
    } else {
        alert("ã‚·ãƒŠãƒªã‚ªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
        goToHome();
    }
  };

  const handleCustomSubmit = async () => {
    if (!customSettings.where || !customSettings.what || isLoading || isSpeakingRef.current) return;
    
    const who = customSettings.who || 'AI';
    const customPrompt = `å ´æ‰€: ${customSettings.where}, ç›¸æ‰‹: ${who}, ç›®çš„: ${customSettings.what}ã€‚ã‚ãªãŸã¯${who}ã§ã™ã€‚`;
    const customScenario = SCENARIOS.find(s => s.id === 'custom');

    setScenario(prev => ({
      ...customScenario,
      title: customSettings.what || 'è‡ªç”±è¨­å®š',
      prompt: customPrompt
    }));
    
    setIsLoading(true); 
    let success = false;
    
    try {
      const script = await generateScript(customPrompt);
      setScriptData(script);
      setScreen('script');
      success = true;
    } catch (error) {
      console.error("Script generation failed:", error);
      // alert("å°æœ¬ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã™ã‚‹ã‹ã€è¨­å®šã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚");
    } finally {
      setIsLoading(false); 
      if (!success) {
        // å¤±æ•—ã—ãŸå ´åˆã®ã¿ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹
        goToHome(); 
      }
    }
  };

  const startChat = () => {
    if(isSpeakingRef.current) return;
    setScreen('chat');
    setMessages([]);
    setFeedback(null);
    setShowScriptModal(false);
    
    const firstLine = scriptData[0]?.en || "Hello! How can I help you today?";
    
    // å°æœ¬ã®æœ€åˆã®ç™ºè¨€ (AI) ã‚’ãƒãƒ£ãƒƒãƒˆã«è¿½åŠ ã—ã€èª­ã¿ä¸Šã’
    setTimeout(() => {
      setMessages([{ role: 'ai', text: firstLine }]);
      handleSpeak(firstLine);
    }, 500);
  };

  const handleSend = async (text) => {
    if (!text.trim() || isLoading || isSpeakingRef.current) return;

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    const userMessage = { role: 'user', text };
    setMessages(prev => [...prev, userMessage]);
    setInputText('');
    setMicStatus('ãƒã‚¤ã‚¯ã‚’æŠ¼ã—ã¦è©±ã™'); 
    
    setIsLoading(true);
    
    try {
      const chatHistoryForAPI = [...messages, userMessage];
      const aiResponseText = await generateAIResponse(scenario.prompt, chatHistoryForAPI);
      
      const aiResponse = { role: 'ai', text: aiResponseText };
      
      // AIå¿œç­”ã®è¿½åŠ ã¨èª­ã¿ä¸Šã’ã‚’åŒæ™‚ã«è¡Œã†
      setMessages(prev => [...prev, aiResponse]);
      await handleSpeak(aiResponseText);

    } catch (error) {
      console.error("AIå¿œç­”ã®ç”Ÿæˆã‚¨ãƒ©ãƒ¼:", error);
      const errorMessage = "AIå¿œç­”ã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
      setMessages(prev => [...prev, { role: 'ai', text: errorMessage }]);
    } finally {
      setIsLoading(false); 
    }
  };

  const finishConversation = async () => {
    if (isLoading || isSpeakingRef.current) return;
    
    const userMessages = messages.filter(m => m.role === 'user');
    if(userMessages.length < 1) {
      // alert("æ¡ç‚¹ã«ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹æœ€ä½1å›ä»¥ä¸Šã®ç™ºè¨€ãŒå¿…è¦ã§ã™ã€‚");
      return;
    }

    setIsLoading(true);
    try {
        const feedbackResult = await generateFeedback(scenario.prompt, messages);
        setFeedback(feedbackResult);
        setScreen('feedback');
    } catch (error) {
        console.error("Feedback generation error:", error);
        // alert("ä¼šè©±åˆ†æï¼ˆãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼‰ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    } finally {
        setIsLoading(false);
    }
  };

  // --- ä¸­æ–­å‡¦ç† ---
  const handleQuit = () => {
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« UI ã‚’ä½¿ç”¨ï¼ˆ`window.confirm`ã¯ä½¿ç”¨ã—ãªã„ï¼‰
    // ä»Šå›ã¯ç°¡ç•¥åŒ–ã®ãŸã‚ã€ã‚¢ãƒ©ãƒ¼ãƒˆçš„ãªæ©Ÿèƒ½ã®ã¾ã¾ã«ã—ã¦ãŠãã¾ã™
    const confirmQuit = () => {
      // ã“ã“ã«ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒå…¥ã‚Šã¾ã™
      // ç¾åœ¨ã¯ç°¡æ˜“çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ä»£ç”¨
      if (window.confirm("ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¸­æ–­ã—ã¦ãƒˆãƒƒãƒ—ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ\nï¼ˆä¼šè©±ãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼‰")) {
          goToHome();
      }
    };
    confirmQuit();
  };

  // --- ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã®ãƒˆã‚°ãƒ«å‡¦ç† ---
  const toggleRecording = () => {
    if (!recognition.current) {
        setMicStatus('âŒ ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
        return;
    }
    
    if (isRecording) {
      // éŒ²éŸ³åœæ­¢
      recognition.current.stop();
      // onendãŒç™ºç«ã™ã‚‹ã®ã‚’å¾…ã¤
    } else {
      // éŒ²éŸ³é–‹å§‹
      
      // èµ·å‹•å‰ã«å¿µã®ãŸã‚åœæ­¢ï¼ˆå‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ®‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§ã‚’æ’é™¤ï¼‰
      recognition.current.abort(); 
      
      // å…¥åŠ›å€¤ã‚’ã‚¯ãƒªã‚¢
      setInputText(''); 
      
      // ã¾ãšã€Œãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­ã€ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¡¨ç¤º
      setMicStatus('ğŸ¤ ãƒã‚¤ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...');
      // onstartã§ isRecording ãŒ true ã«ãªã‚‹ã“ã¨ã‚’æœŸå¾…
      
      try {
        recognition.current.start();
      } catch (e) {
        // ã™ã§ã«èªè­˜ãŒé€²è¡Œä¸­ã®å ´åˆãªã©ã€start()ãŒã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã“ã¨ãŒã‚ã‚‹
        console.warn("Recognition start failed (likely already running or blocked):", e);
        setIsRecording(false);
        setMicStatus('âŒ ãƒã‚¤ã‚¯ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      }
    }
  };

  // --- ç”»é¢ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤
  const LoadingOverlay = () => (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
      <div className="bg-white p-6 rounded-xl shadow-2xl flex flex-col items-center">
        <Loader size={32} className="animate-spin text-indigo-600 mb-3" />
        <p className="font-bold text-lg text-slate-700">AIãŒå‡¦ç†ä¸­...</p>
        <p className="text-sm text-slate-500">ï¼ˆå°æœ¬ç”Ÿæˆ/å¿œç­”/åˆ†æï¼‰</p>
      </div>
    </div>
  );
  
  // æ¨™æº–TTSã§ã¯ isSpeaking ã®çŠ¶æ…‹ãŒé«˜é€Ÿã«åˆ‡ã‚Šæ›¿ã‚ã‚‹ãŸã‚ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’çœç•¥ã™ã‚‹ã‹ã€ç°¡ç•¥åŒ–ã™ã‚‹
  const SpeakingOverlay = () => (
    <div className="fixed top-0 left-0 right-0 p-2 bg-indigo-600/90 text-white z-40 flex items-center justify-center shadow-lg">
        <Volume2 size={20} className="animate-pulse mr-2" />
        <span className="font-semibold text-sm">AIãŒè©±ã—ã¦ã„ã¾ã™...</span>
    </div>
  );

  const ScenarioIcon = ({ icon: Icon, size = 32, className = "text-indigo-600" }) => {
    return <Icon size={size} className={className} />;
  };


  if (screen === 'home') {
    return (
      <div className="min-h-screen bg-slate-50 p-4 font-sans text-slate-800">
        {isLoading && <LoadingOverlay />}
        {isSpeaking && <SpeakingOverlay />}
        <header className="mb-8 text-center pt-8">
          <h1 className="text-3xl font-bold text-indigo-600 mb-2">Instant Talk AI</h1>
          <p className="text-slate-500">ç¬é–“è‹±ä½œæ–‡ & è‹±ä¼šè©±ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°</p>
        </header>

        <div className="max-w-md mx-auto grid grid-cols-1 gap-4">
          <button
            onClick={() => handleScenarioSelect(SCENARIOS.find(s => s.id === 'custom'))}
            className="flex items-center p-4 bg-gradient-to-r from-indigo-500 to-purple-600 text-white rounded-xl shadow-md hover:shadow-lg transition transform hover:-translate-y-1 text-left"
            disabled={isLoading || isSpeaking}
          >
            <span className="mr-4 bg-white/20 p-2 rounded-full"><ScenarioIcon icon={Sparkles} size={32} className="text-white"/></span>
            <div>
              <div className="font-bold text-lg">è‡ªç”±è¨­å®šã§å§‹ã‚ã‚‹ (AIç”Ÿæˆ)</div>
              <div className="text-xs text-indigo-100">å ´æ‰€ã‚„ç›®çš„ã‚’è‡ªç”±ã«è¨­å®šã—ã¦å°æœ¬ã‚’ä½œæˆ</div>
            </div>
            <ArrowRight className="ml-auto opacity-70" />
          </button>

          <div className="grid grid-cols-2 gap-3 mt-2">
             {SCENARIOS.filter(s => s.id !== 'custom').map(s => (
              <button
                key={s.id}
                onClick={() => handleScenarioSelect(s)}
                className="flex flex-col items-center justify-center p-4 bg-white rounded-xl shadow-sm hover:shadow-md transition border border-slate-100 text-center h-32"
                disabled={isLoading || isSpeaking}
              >
                <ScenarioIcon icon={s.icon} size={32} className="text-indigo-500 mb-2" />
                <div className="font-bold text-sm">{s.title} (å³æ™‚é–‹å§‹)</div>
              </button>
            ))}
          </div>
        </div>
      </div>
    );
  }

  if (screen === 'custom_setup') {
    return (
      <div className="min-h-screen bg-slate-50 p-4 font-sans flex items-center justify-center">
        {isLoading && <LoadingOverlay />}
        {isSpeaking && <SpeakingOverlay />}
        <div className="bg-white w-full max-w-md p-6 rounded-2xl shadow-lg">
          <div className="flex justify-between items-center mb-6">
            <h2 className="text-xl font-bold flex items-center gap-2"><Edit3 size={24} className="text-indigo-600"/>ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š</h2>
            <button onClick={goToHome} className="text-slate-400 p-2 hover:bg-slate-100 rounded-full" disabled={isLoading || isSpeaking}><X /></button>
          </div>
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-bold text-slate-600 mb-1">ã©ã“ã§ï¼Ÿ (å¿…é ˆ)</label>
              <input type="text" placeholder="ä¾‹: æºå¸¯ã‚·ãƒ§ãƒƒãƒ—" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg"
                value={customSettings.where} onChange={e => setCustomSettings({...customSettings, where: e.target.value})} disabled={isLoading || isSpeaking} />
            </div>
            <div>
              <label className="block text-sm font-bold text-slate-600 mb-1">èª°ã¨ï¼Ÿ (ä»»æ„)</label>
              <input type="text" placeholder="ä¾‹: åº—å“¡" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg"
                value={customSettings.who} onChange={e => setCustomSettings({...customSettings, who: e.target.value})} disabled={isLoading || isSpeaking} />
            </div>
            <div>
              <label className="block text-sm font-bold text-slate-600 mb-1">ä½•ã‚’ã™ã‚‹ï¼Ÿ (ç›®çš„, å¿…é ˆ)</label>
              <textarea placeholder="ä¾‹: æ–™é‡‘ãŒé«˜ã„ã®ã§è§£ç´„ã—ãŸã„ã€‚" className="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg h-24 resize-none"
                value={customSettings.what} onChange={e => setCustomSettings({...customSettings, what: e.target.value})} disabled={isLoading || isSpeaking} />
            </div>
          </div>
          <button onClick={handleCustomSubmit} disabled={!customSettings.where || !customSettings.what || isLoading || isSpeaking}
            className="w-full mt-6 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-md disabled:opacity-50 flex items-center justify-center gap-2">
            {isLoading ? <><Loader size={20} className="animate-spin" /> å°æœ¬ä½œæˆä¸­...</> : 'å°æœ¬ã‚’ä½œæˆã™ã‚‹ (AIå‡¦ç†)'}
          </button>
        </div>
      </div>
    );
  }

  // --- å°æœ¬ãƒ¢ãƒ¼ãƒ‰ ---
  if (screen === 'script') {
    return (
      <div className="min-h-screen bg-slate-50 p-4 font-sans text-slate-800">
        {isLoading && <LoadingOverlay />}
        {isSpeaking && <SpeakingOverlay />}
        <header className="mb-6 flex items-center justify-between">
          <button 
            onClick={goToHome} 
            className="text-slate-500 flex items-center gap-1 text-sm font-bold px-3 py-2 rounded-lg hover:bg-slate-200 transition"
            disabled={isLoading || isSpeaking}
          >
            <Home size={18} /> ãƒˆãƒƒãƒ—ã¸
          </button>
          <h2 className="text-xl font-bold text-indigo-800 flex items-center gap-2">
            <BookOpen className="text-indigo-600" size={20} />
            å°æœ¬ãƒ¢ãƒ¼ãƒ‰
          </h2>
          <div className="w-16"></div> 
        </header>

        <div className="max-w-md mx-auto mb-20">
          <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-xl mb-6 text-sm text-yellow-800">
            <strong>ğŸ’¡ ä½œæˆ¦ä¼šè­°:</strong><br/>
            AIãŒç”Ÿæˆã—ãŸã“ã®æµã‚Œã‚’å£°ã«å‡ºã—ã¦è¦šãˆã¾ã—ã‚‡ã†ã€‚æº–å‚™ãŒã§ããŸã‚‰ã€Œå®Ÿè·µã€ã¸é€²ã‚“ã§ãã ã•ã„ã€‚
          </div>

          <div className="space-y-4">
            {scriptData.length === 0 ? (
              <div className="text-center p-8 bg-white rounded-xl text-slate-500">å°æœ¬ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¨­å®šã‚’è¦‹ç›´ã—ã¦ãã ã•ã„ã€‚</div>
            ) : (
              scriptData.map((line, idx) => (
                <div key={idx} className={`p-4 rounded-xl border ${line.role === 'ai' ? 'bg-white border-slate-200' : 'bg-indigo-50 border-indigo-100'}`}>
                  <div className="flex justify-between items-start mb-1">
                    <span className={`text-xs font-bold px-2 py-0.5 rounded ${line.role === 'ai' ? 'bg-slate-200 text-slate-600' : 'bg-indigo-200 text-indigo-700'}`}>
                      {line.role === 'ai' ? 'ç›¸æ‰‹' : 'ã‚ãªãŸ'} 
                    </span>
                    <button onClick={() => handleSpeak(line.en)} className="text-indigo-400 hover:text-indigo-600" disabled={isLoading || isSpeaking}><Volume2 size={18} /></button>
                  </div>
                  <p className="font-medium text-lg mb-1">{line.en}</p>
                  <p className="text-sm text-slate-500">{line.ja}</p>
                </div>
              ))
            )}
          </div>
        </div>

        <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-slate-100 max-w-md mx-auto">
          <button onClick={startChat} disabled={scriptData.length === 0 || isLoading || isSpeaking} className="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 text-lg flex items-center justify-center gap-2 animate-bounce-subtle disabled:opacity-50">
            <GraduationCap size={24} />
            å°æœ¬ã‚’é–‰ã˜ã¦å®Ÿè·µã™ã‚‹
          </button>
        </div>
      </div>
    );
  }

  // --- å®Ÿè·µï¼ˆãƒãƒ£ãƒƒãƒˆï¼‰ãƒ¢ãƒ¼ãƒ‰ ---
  if (screen === 'chat') {
    const IconComponent = scenario?.icon || Sparkles;

    const interactionDisabled = isLoading || isSpeaking || isRecording;

    return (
      <div className="min-h-screen bg-slate-50 flex flex-col font-sans relative">
        {isLoading && <LoadingOverlay />}
        {isSpeaking && <SpeakingOverlay />}
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <header className="bg-white p-3 shadow-sm flex items-center justify-between sticky top-0 z-10">
          <button 
            onClick={handleQuit} 
            className="text-slate-500 flex flex-col items-center justify-center p-2 rounded-lg hover:bg-red-50 hover:text-red-500 transition"
            title="ä¸­æ–­ã—ã¦ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹"
            disabled={interactionDisabled}
          >
            <LogOut size={20} />
            <span className="text-[10px] font-bold">ä¸­æ–­</span>
          </button>

          <div className="flex flex-col items-center">
            <span className="font-bold text-slate-800 text-sm max-w-[150px] truncate">{scenario.title}</span>
            <span className="text-[10px] text-red-500 font-bold flex items-center gap-1">
              <span className="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></span> å®Ÿè·µä¸­
            </span>
          </div>
          
          <div className="flex gap-2">
            <button onClick={() => setShowScriptModal(true)} className="text-indigo-600 bg-indigo-50 p-2 rounded-full hover:bg-indigo-100" title="å°æœ¬ã‚’ç¢ºèª" disabled={interactionDisabled}>
              <BookOpen size={20} />
            </button>
            <button onClick={finishConversation} className="text-sm bg-indigo-600 text-white px-3 py-2 rounded-lg hover:bg-indigo-700 font-bold shadow-sm" disabled={interactionDisabled}>
              æ¡ç‚¹ã™ã‚‹ (AIå‡¦ç†)
            </button>
          </div>
        </header>

        {/* å°æœ¬ãƒ¢ãƒ¼ãƒ€ãƒ« */}
        {showScriptModal && (
          <div className="absolute inset-0 z-50 bg-black/50 flex justify-end">
            <div className="w-3/4 bg-white h-full shadow-2xl p-4 overflow-y-auto animate-in slide-in-from-right">
              <div className="flex justify-between items-center mb-4 border-b pb-2">
                <h3 className="font-bold text-slate-700">å°æœ¬ãƒã‚§ãƒƒã‚¯</h3>
                <button onClick={() => setShowScriptModal(false)}><X size={24} /></button>
              </div>
              <div className="space-y-4">
                {scriptData.map((line, idx) => (
                  <div key={idx} className={`text-sm p-3 rounded-lg ${line.role === 'user' ? 'bg-indigo-50' : 'bg-slate-50'}`}>
                    <div className="font-bold mb-1 text-slate-400 text-xs">{line.role === 'ai' ? 'ç›¸æ‰‹' : 'ã‚ãªãŸ'}</div>
                    <div className="font-medium text-slate-800">{line.en}</div>
                    <div className="text-xs text-slate-500">{line.ja}</div>
                  </div>
                ))}
              </div>
              <button onClick={() => setShowScriptModal(false)} className="w-full mt-4 py-2 bg-indigo-600 text-white rounded-lg">é–‰ã˜ã‚‹</button>
            </div>
          </div>
        )}

        {/* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */}
        <div className="flex-1 overflow-y-auto p-4 space-y-6">
          {messages.map((msg, index) => (
            <div key={index} className={`flex items-end gap-2 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
              {msg.role === 'ai' && (
                <div className="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 flex-shrink-0">
                  <IconComponent size={20} />
                </div>
              )}
              <div className={`max-w-[75%] rounded-2xl p-3 shadow-sm ${msg.role === 'user' ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white text-slate-800 border border-slate-200 rounded-bl-none'}`}>
                {msg.role === 'ai' && !showSubtitles && !isSpeaking ? (
                  <div className="italic text-slate-400 text-sm flex items-center gap-1"><Volume2 size={14} /> (éŸ³å£°ã®ã¿)</div>
                ) : (
                  <p className="leading-relaxed whitespace-pre-wrap">{msg.text}</p>
                )}
              </div>
              {msg.role === 'ai' && (
                <button onClick={() => handleSpeak(msg.text)} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition-colors flex-shrink-0" disabled={interactionDisabled}>
                  <Volume2 size={20} />
                </button>
              )}
            </div>
          ))}
          <div ref={messagesEndRef} />
        </div>

        {/* å…¥åŠ›ã‚¨ãƒªã‚¢ */}
        <div className="bg-white p-4 border-t border-slate-100 pb-8">
          <div className="flex items-center justify-between mb-2">
            <label className="flex items-center text-xs text-slate-500 cursor-pointer">
              <input type="checkbox" checked={showSubtitles} onChange={() => setShowSubtitles(!showSubtitles)} className="mr-1 accent-indigo-600" disabled={interactionDisabled}/> å­—å¹•
            </label>
            {/* ãƒã‚¤ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚’å¼·åŒ– */}
            <div className={`text-xs font-bold transition-colors ${
                isRecording ? 'text-red-500 animate-pulse' : 
                (micStatus.includes('ã‚¨ãƒ©ãƒ¼') || micStatus.includes('æ‹’å¦') || micStatus.includes('æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ')) ? 'text-red-600' :
                'text-slate-500'
            }`}>
              {micStatus}
            </div>
          </div>

          <div className="flex items-center gap-2">
            <button onClick={toggleRecording}
              className={`p-3 rounded-full transition-all ${isRecording ? 'bg-red-500 text-white' : 'bg-slate-100 text-slate-600'}`} disabled={interactionDisabled}>
              {isRecording ? <MicOff size={24} /> : <Mic size={24} />}
            </button>
            <input type="text" value={inputText} onChange={(e) => setInputText(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSend(inputText)}
              placeholder="å®Ÿè·µãƒ¢ãƒ¼ãƒ‰..." className="flex-1 bg-slate-50 border border-slate-200 rounded-full px-4 py-2 focus:outline-none focus:border-indigo-500" disabled={interactionDisabled} />
            <button onClick={() => handleSend(inputText)} disabled={!inputText.trim() || interactionDisabled} className="p-3 bg-indigo-600 text-white rounded-full disabled:opacity-50">
              {(isLoading && !isSpeaking) ? <Loader size={20} className="animate-spin" /> : <Send size={20} />}
            </button>
          </div>
        </div>
      </div>
    );
  }

  // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”»é¢
  if (screen === 'feedback') {
    return (
      <div className="min-h-screen bg-slate-50 font-sans p-4">
        {isLoading && <LoadingOverlay />}
        {isSpeaking && <SpeakingOverlay />}
        <header className="mb-6 flex items-center justify-between">
          <h2 className="text-2xl font-bold text-slate-800">ä¼šè©±åˆ†æ (AIçµæœ)</h2>
          <button onClick={goToHome} className="text-slate-500 p-2 hover:bg-slate-100 rounded-full" disabled={isLoading}><Home size={24} /></button>
        </header>
        <div className="space-y-6 max-w-lg mx-auto pb-20">
          <div className="bg-white p-6 rounded-2xl shadow-sm text-center border-t-4 border-indigo-600">
            <div className="text-slate-500 mb-1 font-semibold text-sm">ã‚·ãƒŠãƒªã‚ª: {scenario?.title || 'ä¸æ˜'}</div>
            <div className="text-slate-500 mb-1">ç·åˆã‚¹ã‚³ã‚¢</div>
            <div className="text-6xl font-extrabold text-indigo-600 mb-2 leading-none">{feedback?.score || '--'}</div>
            <p className="text-sm text-slate-600 mt-3 whitespace-pre-wrap">
              <Lightbulb size={16} className="inline text-yellow-500 mr-1" />
              {feedback?.summary || 'AIã«ã‚ˆã‚‹åˆ†æçµæœã‚’å¾…ã£ã¦ã„ã¾ã™...'}
            </p>
          </div>
          <div className="bg-white p-6 rounded-2xl shadow-sm">
            <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><CheckCircle className="text-orange-500" size={20} />æ–‡æ³•ãƒ»è¡¨ç¾ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h3>
            <div className="space-y-4">
              {feedback?.grammarPoints?.length > 0 ? (
                feedback.grammarPoints.map((point, i) => (
                  <div key={i} className="border-b border-slate-100 last:border-0 pb-3 last:pb-0">
                    <p className="text-slate-600 text-sm line-through">èª¤: {point.original}</p>
                    <p className="text-slate-800 font-bold text-sm">æ­£: {point.corrected}</p>
                    <p className="text-xs text-slate-500 bg-slate-50 p-2 rounded mt-1 whitespace-pre-wrap">ğŸ’¡ {point.explanation}</p>
                  </div>
                ))
              ) : (
                <p className="text-sm text-slate-500">æ”¹å–„ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ç´ æ™´ã‚‰ã—ã„ã§ã™ï¼</p>
              )}
            </div>
          </div>

          <div className="bg-white p-6 rounded-2xl shadow-sm">
            <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><MessageSquare className="text-green-600" size={20} />æ¨å¥¨ãƒ•ãƒ¬ãƒ¼ã‚º</h3>
            <ul className="list-disc list-inside space-y-2 text-sm text-slate-700">
              {feedback?.suggestedPhrases?.map((phrase, i) => (
                <li key={i} className="bg-green-50 p-2 rounded font-mono border border-green-200">{phrase}</li>
              ))}
            </ul>
            {feedback?.suggestedPhrases?.length === 0 && <p className="text-sm text-slate-500">ç‰¹ã«ãŠã™ã™ã‚ã®ãƒ•ãƒ¬ãƒ¼ã‚ºã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>}
          </div>
        </div>
        <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-slate-100 flex gap-4 max-w-md mx-auto z-20">
          <button onClick={goToHome} className="flex-1 py-3 text-slate-600 font-bold border border-slate-300 rounded-xl" disabled={isLoading}>çµ‚äº†</button>
          <button onClick={() => setScreen('script')} className="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 flex items-center justify-center gap-2" disabled={isLoading}>
            <RotateCcw size={18} /> å°æœ¬ã‹ã‚‰ã‚„ã‚Šç›´ã™
          </button>
        </div>
      </div>
    );
  }
  return null;
}
